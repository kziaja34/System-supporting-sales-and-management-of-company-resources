@page "/reservations"
@using SSSMCR.Web.Components.Components.Tables
@using SSSMCR.Web.Services
@inject IUserService UserService
@inject IAuthService AuthService
@inject NavigationManager Nav
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<MudPaper Class="pa-4" Width="115%" elevation="1">
    <MudText Typo="Typo.h5" Class="mb-4">Reservations</MudText>

    @if (_ready)
    {
        <ReservationsTable InitialBranchId="@_userBranchId"
                           UserBranchId="@_userBranchId" />
    }
</MudPaper>

@code {
    private int _userBranchId;
    private bool _ready;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            var role = await LocalStorage.GetItemAsync<string>("user_role");
            if (!AuthService.PermittedForWarehouse(role))
            {
                Nav.NavigateTo("/");
                return;
            }
        }
        catch
        {
            // ignore prerender exceptions
        }

        var me = await UserService.GetMeAsync();
        _userBranchId = me.BranchId;

        _ready = true;
        StateHasChanged();
    }
}